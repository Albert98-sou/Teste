name: Gamer-PC-32GB-Virtual

on:
  workflow_dispatch:

jobs:
  gamer:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

      - name: Install Programs
        run: |
          choco install tailscale -y
          choco install steam -y
        shell: powershell

      - name: Create 32GB Virtual RAM (Pagefile)
        run: |
          wmic pagefileset where name="C:\\pagefile.sys" set InitialSize=32768,MaximumSize=32768
        shell: powershell

      - name: Create 512GB Virtual Disk
        run: |
          $VHDPath = "C:\gamer512.vhd"
          New-VHD -Path $VHDPath -SizeBytes 512GB -Dynamic
          Mount-VHD -Path $VHDPath
          Initialize-Disk -Number 1 -PartitionStyle GPT
          New-Partition -DiskNumber 1 -UseMaximumSize -AssignDriveLetter | Format-Volume -FileSystem NTFS -Confirm:$false
        shell: powershell

      - name: Start Tailscale
        run: |
          Start-Service Tailscale
          tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --accept-routes
        shell: powershell

      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        shell: powershell

      - name: Create Gamer User
        run: |
          net user Gamer32 P@ssGamer32 /add
          net localgroup administrators Gamer32 /add
        shell: powershell

      - name: Show Info
        run: |
          echo "========== PC GAMER READY =========="
          echo "User: Gamer32"
          echo "Pass: P@ssGamer32"
          echo "Tailscale IP:"
          tailscale ip -4
          echo "====================================="
        shell: powershell

      - name: Keep Alive
        run: |
          ping 127.0.0.1 -t
        shell: powershell
