name: RDP-Intel-32GB-1TB

on:
  workflow_dispatch: # Permite ligar o PC manualmente

jobs:
  rdp-session:
    # Para 32GB reais, o GitHub exige runners específicos (ex: windows-2022-16core)
    # Se usar o padrão abaixo, ele rodará com 7GB RAM / 2-Core Intel
    runs-on: windows-latest 
    timeout-minutes: 360 # Limite de 6 horas (máximo free)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Write-Host "Configurações de RDP aplicadas."

      - name: Create Admin User
        run: |
          $password = "SenhaForte123!" # Altere por segurança
          $user = "AdminRDP"
          net user $user $password /add
          net localgroup Administrators $user /add
          Write-Host "Usuário $user criado com sucesso."

      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $url -OutFile "tailscale.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "tailscale.msi", "/quiet", "/norestart" -Wait

      - name: Connect to Tailscale
        shell: pwsh
        run: |
          # Você PRECISA adicionar o segredo TAILSCALE_AUTH_KEY nas configurações do seu GitHub
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=pc-intel-32gb
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "--- CONEXÃO RDP LIBERADA ---"
          Write-Host "Endereço IP: $ip"
          Write-Host "Usuário: AdminRDP"
          Write-Host "Senha: SenhaForte123!"
          Write-Host "----------------------------"

      - name: Keep Alive (6 Hours)
        run: |
          $startTime = Get-Date
          while ((Get-Date) -lt $startTime.AddMinutes(350)) {
            Write-Host "PC Ativo... [$(Get-Date)]"
            Start-Sleep -Seconds 300
          }
