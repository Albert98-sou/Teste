name: Deploy-Azure-GPU-Server

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # =============================
      # LOGIN AZURE
      # =============================
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # =============================
      # CREATE RESOURCE GROUP
      # =============================
      - name: Create Resource Group
        run: |
          az group create \
            --name UnrealGPUGroup \
            --location eastus

      # =============================
      # CREATE GPU VM (A10 - 24GB VRAM)
      # =============================
      - name: Create GPU VM
        run: |
          az vm create \
            --resource-group UnrealGPUGroup \
            --name UnrealGPUServer \
            --image Win2022Datacenter \
            --size Standard_NVadsA10_v5 \
            --admin-username UnrealAdmin \
            --generate-ssh-keys false \
            --authentication-type password \
            --admin-password $(openssl rand -base64 16) \
            --public-ip-sku Standard

      # =============================
      # OPEN RDP PORT
      # =============================
      - name: Open RDP Port
        run: |
          az vm open-port \
            --resource-group UnrealGPUGroup \
            --name UnrealGPUServer \
            --port 3389

      # =============================
      # INSTALL NVIDIA GPU DRIVER
      # =============================
      - name: Install NVIDIA Drivers
        run: |
          az vm extension set \
            --resource-group UnrealGPUGroup \
            --vm-name UnrealGPUServer \
            --name NvidiaGpuDriverWindows \
            --publisher Microsoft.HpcCompute

      # =============================
      # SHOW PUBLIC IP
      # =============================
      - name: Show Public IP
        run: |
          az vm show \
            --resource-group UnrealGPUGroup \
            --name UnrealGPUServer \
            -d --query publicIps -o tsv
