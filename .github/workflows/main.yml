name: Deploy-Azure-GPU-Server

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # =============================
      # LOGIN AZURE
      # =============================
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      # =============================
      # CREATE RESOURCE GROUP
      # =============================
      - name: Create Resource Group
        run: |
          az group create \
            --name UnrealGPUGroup \
            --location eastus

      # =============================
      # CREATE GPU VM
      # =============================
      - name: Create GPU VM
        run: |
          az vm create \
            --resource-group UnrealGPUGroup \
            --name UnrealGPUServer \
            --image Win2022Datacenter \
            --size Standard_NVadsA10_v5 \
            --admin-username UnrealAdmin \
            --admin-password P@ssUnreal123! \
            --public-ip-sku Standard \
            --authentication-type password

      # =============================
      # INSTALL NVIDIA DRIVER EXTENSION
      # =============================
      - name: Install NVIDIA Drivers
        run: |
          az vm extension set \
            --resource-group UnrealGPUGroup \
            --vm-name UnrealGPUServer \
            --name NvidiaGpuDriverWindows \
            --publisher Microsoft.HpcCompute
