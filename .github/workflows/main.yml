name: Windows-Remote-Desktop

on: 
  workflow_dispatch: # Permite que você inicie o processo manualmente

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 # Tempo máximo de duração (6 horas)

    steps:
    - name: Baixando e Configurando o Ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        
    - name: Autenticando no Ngrok
      run: .\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      # Você deve adicionar seu Token do Ngrok nos Secrets do repositório com o nome NGROK_AUTH_TOKEN

    - name: Ativando Acesso RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Criando Túnel Ngrok
      run: Start-Process Powershell -ArgumentList '-NoExit -Command ".\ngrok\ngrok.exe tcp 3389"'

    - name: Mantendo a conexão viva
      run: |
        echo "Acesse seu painel do Ngrok para pegar o IP e Porta de conexão"
        echo "Usuário: runneradmin"
        echo "Senha: Use o comando 'net user runneradmin nova_senha' se precisar alterar"
        sleep 21600 # Mantém rodando por 6 horas
