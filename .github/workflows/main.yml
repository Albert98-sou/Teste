name: UE5-16CPU-RTX

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y jq
          pip install vastai

      - name: Set API Key
        run: |
          vastai set api-key ${{ secrets.VAST_API_KEY }}

      - name: Get RTX 4090 + 16 CPU
        run: |
          OFFER=$(vastai search offers "gpu_name=RTX_4090 cpu_cores>=16 rentable=True verified=True" --raw | jq -r 'sort_by(.dph_total) | .[0].id')
          echo "OFFER_ID=$OFFER" >> $GITHUB_ENV

      - name: Create Windows 11 RTX Machine
        run: |
          vastai create instance $OFFER_ID \
            --image vastai/windows11 \
            --disk 200

      - name: Show Instance Info
        run: |
          vastai show instances
